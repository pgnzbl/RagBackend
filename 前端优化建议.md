# å‰ç«¯ä¼˜åŒ–å»ºè®®

åŸºäºåç«¯APIä¼˜åŒ–ï¼Œä»¥ä¸‹æ˜¯å‰ç«¯ä¼˜åŒ–æ–¹å‘å’Œå…·ä½“å®ç°å»ºè®®ã€‚

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–æ–¹å‘

### 1. **åˆ†é˜¶æ®µåŠ è½½ç­–ç•¥** â­â­â­â­â­

#### é—®é¢˜
ç›´æ¥åŠ è½½æ‰€æœ‰æ–‡æ¡£çš„å®Œæ•´é¢„è§ˆä¼šå¯¼è‡´ï¼š
- åˆå§‹åŠ è½½æ…¢
- æ•°æ®ä¼ è¾“é‡å¤§
- ç”¨æˆ·ä½“éªŒå·®

#### è§£å†³æ–¹æ¡ˆï¼šä¸¤æ­¥åŠ è½½æ³•

```javascript
// ç¬¬ä¸€æ­¥ï¼šå¿«é€Ÿè·å–æ–‡ä»¶åˆ—è¡¨ï¼ˆè½»é‡çº§ï¼‰
async function loadFileList(kbName) {
  const response = await apiRequest(
    `/kb/${kbName}/docs?include_preview=false`
  );
  
  // åªæ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨å’Œç»Ÿè®¡ä¿¡æ¯
  return response.files.map(file => ({
    filename: file.filename,
    chunksCount: file.chunks_count,
    metadata: file.file_metadata,
    // chunks ä¸ºç©ºæ•°ç»„ï¼ŒæŒ‰éœ€åŠ è½½
    chunks: []
  }));
}

// ç¬¬äºŒæ­¥ï¼šæŒ‰éœ€åŠ è½½æ–‡ä»¶è¯¦æƒ…
async function loadFileDetails(kbName, filename) {
  // å¯ä»¥è°ƒç”¨å®Œæ•´APIè·å–é¢„è§ˆï¼Œæˆ–è€…æ·»åŠ æ–°çš„APIç«¯ç‚¹
  const response = await apiRequest(
    `/kb/${kbName}/docs?include_preview=true&max_preview_chunks=20`
  );
  
  const file = response.files.find(f => f.filename === filename);
  return file?.chunks || [];
}
```

#### å®ç°ç¤ºä¾‹

```javascript
class DocumentList {
  constructor(kbName) {
    this.kbName = kbName;
    this.files = [];
    this.loadedDetails = new Set(); // è®°å½•å·²åŠ è½½è¯¦æƒ…çš„æ–‡ä»¶
  }
  
  // åˆå§‹åŠ è½½ï¼šåªè·å–æ–‡ä»¶åˆ—è¡¨
  async init() {
    try {
      this.files = await loadFileList(this.kbName);
      this.renderFileList();
    } catch (error) {
      console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
    }
  }
  
  // å±•å¼€æ–‡ä»¶è¯¦æƒ…ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
  async expandFile(filename) {
    if (this.loadedDetails.has(filename)) {
      // å·²åŠ è½½ï¼Œç›´æ¥æ˜¾ç¤º
      return;
    }
    
    // æ˜¾ç¤ºåŠ è½½ä¸­çŠ¶æ€
    this.showLoading(filename);
    
    try {
      const chunks = await loadFileDetails(this.kbName, filename);
      // æ›´æ–°æ–‡ä»¶æ•°æ®
      const file = this.files.find(f => f.filename === filename);
      if (file) {
        file.chunks = chunks;
        this.loadedDetails.add(filename);
      }
      this.renderFileDetails(filename);
    } catch (error) {
      console.error('åŠ è½½æ–‡ä»¶è¯¦æƒ…å¤±è´¥:', error);
      this.showError(filename);
    }
  }
  
  renderFileList() {
    // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºæ–‡ä»¶åå’Œchunksæ•°é‡ï¼‰
    // å¯ä»¥æŠ˜å /å±•å¼€ï¼Œç‚¹å‡»å±•å¼€æ—¶æ‰åŠ è½½è¯¦æƒ…
  }
}
```

---

### 2. **è™šæ‹Ÿæ»šåŠ¨ï¼ˆVirtual Scrollingï¼‰** â­â­â­â­

#### é€‚ç”¨åœºæ™¯
å½“æ–‡ä»¶æ•°é‡å¾ˆå¤šï¼ˆ>50ä¸ªï¼‰æ—¶ï¼Œä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨å‡å°‘DOMèŠ‚ç‚¹ã€‚

#### å®ç°å»ºè®®

```javascript
// ä½¿ç”¨ vue-virtual-scroller æˆ– react-window
import { RecycleScroller } from 'vue-virtual-scroller';

// ç¤ºä¾‹ï¼šVueç»„ä»¶
<template>
  <RecycleScroller
    class="file-list"
    :items="files"
    :item-size="80"
    key-field="filename"
    v-slot="{ item }"
  >
    <FileItem 
      :file="item" 
      @expand="expandFile(item.filename)"
    />
  </RecycleScroller>
</template>
```

#### Reactå®ç°ç¤ºä¾‹

```javascript
import { FixedSizeList } from 'react-window';

function FileList({ files, onExpand }) {
  const Row = ({ index, style }) => (
    <div style={style}>
      <FileItem 
        file={files[index]} 
        onExpand={onExpand}
      />
    </div>
  );
  
  return (
    <FixedSizeList
      height={600}
      itemCount={files.length}
      itemSize={80}
      width="100%"
    >
      {Row}
    </FixedSizeList>
  );
}
```

---

### 3. **ç¼“å­˜ç­–ç•¥** â­â­â­â­

#### æœ¬åœ°ç¼“å­˜æ–‡ä»¶åˆ—è¡¨

```javascript
class DocumentCache {
  constructor(kbName) {
    this.kbName = kbName;
    this.cacheKey = `kb_docs_${kbName}`;
    this.cacheExpiry = 5 * 60 * 1000; // 5åˆ†é’Ÿ
  }
  
  // è·å–ç¼“å­˜
  get() {
    const cached = localStorage.getItem(this.cacheKey);
    if (!cached) return null;
    
    const { data, timestamp } = JSON.parse(cached);
    const now = Date.now();
    
    // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    if (now - timestamp > this.cacheExpiry) {
      localStorage.removeItem(this.cacheKey);
      return null;
    }
    
    return data;
  }
  
  // è®¾ç½®ç¼“å­˜
  set(data) {
    const cacheData = {
      data,
      timestamp: Date.now()
    };
    localStorage.setItem(this.cacheKey, JSON.stringify(cacheData));
  }
  
  // æ¸…é™¤ç¼“å­˜
  clear() {
    localStorage.removeItem(this.cacheKey);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
async function getDocuments(kbName, useCache = true) {
  const cache = new DocumentCache(kbName);
  
  // å°è¯•ä»ç¼“å­˜è·å–
  if (useCache) {
    const cached = cache.get();
    if (cached) {
      return cached;
    }
  }
  
  // ä»APIè·å–
  const data = await loadFileList(kbName);
  
  // æ›´æ–°ç¼“å­˜
  cache.set(data);
  
  return data;
}

// ä¸Šä¼ æ–‡ä»¶åæ¸…é™¤ç¼“å­˜
async function uploadFile(kbName, file) {
  await apiRequest(`/kb/${kbName}/upload`, {
    method: 'POST',
    body: formData
  });
  
  // æ¸…é™¤ç¼“å­˜ï¼Œå¼ºåˆ¶åˆ·æ–°
  const cache = new DocumentCache(kbName);
  cache.clear();
}
```

---

### 4. **æœç´¢å’Œè¿‡æ»¤** â­â­â­

#### å®¢æˆ·ç«¯æœç´¢ï¼ˆé’ˆå¯¹å·²åŠ è½½çš„æ–‡ä»¶ï¼‰

```javascript
class DocumentSearch {
  constructor(files) {
    this.files = files;
  }
  
  search(query) {
    if (!query.trim()) {
      return this.files;
    }
    
    const lowerQuery = query.toLowerCase();
    
    return this.files.filter(file => {
      // æŒ‰æ–‡ä»¶åæœç´¢
      if (file.filename.toLowerCase().includes(lowerQuery)) {
        return true;
      }
      
      // æŒ‰æ–‡ä»¶å…ƒæ•°æ®æœç´¢
      const metadata = JSON.stringify(file.file_metadata || {});
      if (metadata.toLowerCase().includes(lowerQuery)) {
        return true;
      }
      
      return false;
    });
  }
  
  // æŒ‰æ–‡ä»¶ç±»å‹è¿‡æ»¤
  filterByType(type) {
    return this.files.filter(file => {
      const fileType = file.file_metadata?.file_type;
      return fileType === type;
    });
  }
}
```

---

### 5. **åŠ è½½çŠ¶æ€å’Œé”™è¯¯å¤„ç†** â­â­â­â­

#### ä¼˜é›…çš„åŠ è½½çŠ¶æ€

```javascript
// Vueç¤ºä¾‹
<template>
  <div class="document-list">
    <!-- éª¨æ¶å± -->
    <SkeletonLoader v-if="loading" />
    
    <!-- æ–‡ä»¶åˆ—è¡¨ -->
    <FileList v-else-if="files.length" :files="files" />
    
    <!-- ç©ºçŠ¶æ€ -->
    <EmptyState v-else-if="!loading" message="æš‚æ— æ–‡æ¡£" />
    
    <!-- é”™è¯¯çŠ¶æ€ -->
    <ErrorState 
      v-if="error" 
      :error="error"
      @retry="loadDocuments"
    />
  </div>
</template>

<script>
export default {
  data() {
    return {
      loading: false,
      files: [],
      error: null
    };
  },
  
  methods: {
    async loadDocuments() {
      this.loading = true;
      this.error = null;
      
      try {
        this.files = await loadFileList(this.kbName);
      } catch (err) {
        this.error = err.message;
      } finally {
        this.loading = false;
      }
    }
  }
};
</script>
```

---

### 6. **åˆ†é¡µæˆ–æ— é™æ»šåŠ¨** â­â­â­

#### å¦‚æœåç«¯æ”¯æŒåˆ†é¡µ

```javascript
class PaginatedDocumentList {
  constructor(kbName) {
    this.kbName = kbName;
    this.page = 1;
    this.pageSize = 20;
    this.hasMore = true;
  }
  
  async loadNext() {
    if (!this.hasMore) return;
    
    const response = await apiRequest(
      `/kb/${this.kbName}/docs?page=${this.page}&page_size=${this.pageSize}`
    );
    
    this.files = [...this.files, ...response.files];
    this.hasMore = response.has_more;
    this.page++;
  }
}
```

---

### 7. **æ€§èƒ½ç›‘æ§** â­â­â­

#### è®°å½•å…³é”®æŒ‡æ ‡

```javascript
class PerformanceMonitor {
  static trackLoadTime(operation, fn) {
    const start = performance.now();
    
    return fn().then(result => {
      const duration = performance.now() - start;
      console.log(`[Performance] ${operation}: ${duration.toFixed(2)}ms`);
      
      // å¯ä»¥å‘é€åˆ°åˆ†ææœåŠ¡
      if (duration > 1000) {
        console.warn(`[Performance Warning] ${operation} è€—æ—¶è¿‡é•¿`);
      }
      
      return result;
    });
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const files = await PerformanceMonitor.trackLoadTime(
  'åŠ è½½æ–‡ä»¶åˆ—è¡¨',
  () => loadFileList(kbName)
);
```

---

## ğŸ“‹ å®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆç¤ºä¾‹

### æ¨èçš„ç»„ä»¶ç»“æ„

```
DocumentManager
â”œâ”€â”€ DocumentList (è½»é‡çº§åˆ—è¡¨)
â”‚   â”œâ”€â”€ FileItem (æ–‡ä»¶é¡¹)
â”‚   â”‚   â”œâ”€â”€ FileHeader (æ–‡ä»¶åã€ç»Ÿè®¡ä¿¡æ¯)
â”‚   â”‚   â””â”€â”€ FileDetails (å±•å¼€æ—¶åŠ è½½)
â”‚   â”‚       â””â”€â”€ ChunkPreview (chunké¢„è§ˆåˆ—è¡¨)
â”‚   â””â”€â”€ LoadingState
â”œâ”€â”€ DocumentSearch (æœç´¢æ )
â”œâ”€â”€ DocumentFilter (è¿‡æ»¤å™¨)
â””â”€â”€ DocumentActions (æ‰¹é‡æ“ä½œ)
```

### æ¨èçš„åŠ è½½æµç¨‹

```
1. é¡µé¢åŠ è½½
   â†“
2. æ˜¾ç¤ºéª¨æ¶å±
   â†“
3. å¿«é€ŸåŠ è½½æ–‡ä»¶åˆ—è¡¨ (include_preview=false)
   â†“
4. æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨ï¼ˆåªæ˜¾ç¤ºæ–‡ä»¶åå’Œç»Ÿè®¡ï¼‰
   â†“
5. ç”¨æˆ·äº¤äº’
   â”œâ”€ ç‚¹å‡»å±•å¼€ â†’ æŒ‰éœ€åŠ è½½æ–‡ä»¶è¯¦æƒ…
   â”œâ”€ æœç´¢ â†’ å®¢æˆ·ç«¯è¿‡æ»¤
   â””â”€ ä¸Šä¼ æ–‡ä»¶ â†’ æ¸…é™¤ç¼“å­˜ â†’ é‡æ–°åŠ è½½
```

---

## ğŸ¨ UI/UX ä¼˜åŒ–å»ºè®®

### 1. **æ¸è¿›å¼ä¿¡æ¯å±•ç¤º**

```javascript
// æ–‡ä»¶é¡¹ç»„ä»¶
<FileItem>
  {/* å§‹ç»ˆæ˜¾ç¤º */}
  <FileHeader>
    <Icon type="file" />
    <FileName>{filename}</FileName>
    <FileStats>{chunksCount} chunks</FileStats>
  </FileHeader>
  
  {/* å±•å¼€æ—¶æ˜¾ç¤º */}
  {expanded && (
    <FileDetails>
      {loading ? (
        <Spinner />
      ) : (
        <ChunkList chunks={chunks} />
      )}
    </FileDetails>
  )}
</FileItem>
```

### 2. **æ‰¹é‡æ“ä½œ**

```javascript
// æ”¯æŒæ‰¹é‡åˆ é™¤ã€å¯¼å‡ºç­‰
class BatchOperations {
  constructor(files) {
    this.selectedFiles = new Set();
    this.files = files;
  }
  
  selectFile(filename) {
    this.selectedFiles.add(filename);
  }
  
  async batchDelete(kbName) {
    const fileIds = Array.from(this.selectedFiles)
      .flatMap(filename => {
        const file = this.files.find(f => f.filename === filename);
        return file.chunks.map(c => c.id);
      });
    
    await apiRequest(`/kb/${kbName}/docs`, {
      method: 'DELETE',
      body: { doc_ids: fileIds }
    });
  }
}
```

### 3. **æ‹–æ‹½ä¸Šä¼ **

```javascript
// æ‹–æ‹½ä¸Šä¼ ä¼˜åŒ–
class DragDropUpload {
  constructor(container, onUpload) {
    this.container = container;
    this.onUpload = onUpload;
    this.init();
  }
  
  init() {
    this.container.addEventListener('dragover', this.handleDragOver);
    this.container.addEventListener('drop', this.handleDrop);
  }
  
  handleDragOver(e) {
    e.preventDefault();
    this.container.classList.add('drag-over');
  }
  
  async handleDrop(e) {
    e.preventDefault();
    this.container.classList.remove('drag-over');
    
    const files = Array.from(e.dataTransfer.files);
    await Promise.all(
      files.map(file => this.onUpload(file))
    );
  }
}
```

---

## ğŸš€ æ¨èçš„ä¼˜åŒ–ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§** â­â­â­â­â­
   - åˆ†é˜¶æ®µåŠ è½½ï¼ˆè½»é‡çº§åˆ—è¡¨ + æŒ‰éœ€è¯¦æƒ…ï¼‰
   - ç¼“å­˜ç­–ç•¥
   - é”™è¯¯å¤„ç†å’ŒåŠ è½½çŠ¶æ€

2. **ä¸­ä¼˜å…ˆçº§** â­â­â­
   - è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚æœæ–‡ä»¶æ•°é‡å¤šï¼‰
   - æœç´¢å’Œè¿‡æ»¤
   - æ€§èƒ½ç›‘æ§

3. **ä½ä¼˜å…ˆçº§** â­â­
   - åˆ†é¡µ/æ— é™æ»šåŠ¨
   - æ‰¹é‡æ“ä½œ
   - æ‹–æ‹½ä¸Šä¼ 

---

## ğŸ“ ä»£ç ç¤ºä¾‹æ€»ç»“

### æ¨èçš„APIè°ƒç”¨æ–¹å¼

```javascript
// 1. åˆå§‹åŠ è½½ï¼šåªè·å–æ–‡ä»¶åˆ—è¡¨
const fileList = await apiRequest(
  `/kb/${kbName}/docs?include_preview=false`
);

// 2. æŸ¥çœ‹æ–‡ä»¶è¯¦æƒ…ï¼šæŒ‰éœ€åŠ è½½
const fileDetails = await apiRequest(
  `/kb/${kbName}/docs?include_preview=true&max_preview_chunks=10`
);

// 3. ä¸Šä¼ åï¼šæ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°
cache.clear();
const updatedList = await apiRequest(
  `/kb/${kbName}/docs?include_preview=false`
);
```

è¿™äº›ä¼˜åŒ–å¯ä»¥æ˜¾è‘—æå‡å‰ç«¯æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒï¼

